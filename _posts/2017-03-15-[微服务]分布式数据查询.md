---
layout: post
title: '微服务分布式数据查询'
date: 2017-03-15
author: Feihang Han
cover: 'http://on2171g4d.bkt.clouddn.com/jekyll-banner.png'
tags: 微服务
---

# 分布式数据查询

微服务架构下，不同的微服务使用的数据库类型，有的是关系型数据库，有的是非关系型数据库。用户查询数据时，往往会跨多个微服务，也就是分布式数据查询。由于微服务的数据都是私有化的，只能通过其暴露的REST接口获取。每个业务模块如果通过调用这些REST接口查询数据，并在内存中组装后，返回用户，这显然是不高效的。那么该如何解决这个问题？

### 物化视图（merialized views）

物化视图是查询的预计算（物化）结果，它是远程数据的本地副本，也可以成为快照。与简单视图不同，物化视图的结果存储在某处，通常在表中。物化视图往往用在需要立即响应的查询上，或者查询结果比较费时。物化视图必须在一段时间内刷新一次。它取决于刷新物化视图的频率以及实际内容如何。基本上物化视图可以立即或延迟刷新，它可以完全刷新或在某一时间点刷新。

总之，使用物化视图可以提高查询性能。

### 命令查询职责分离（CQRS）

在单体应用中，查询和修改往往使用的是相同的实体。在业务逻辑简单的系统中，这没有什么问题，但是随着系统变得复杂，这会产生一定的性能问题。

CQRS使用分离的接口将数据查询操作与数据执行操作分离开来，这也意味着在查询和更新过程中使用的数据模型可以是不一样的。主数据库处理CUD，从数据库处理R，从库的数据结构可以根据业务需求进行合理的设计，而不需要和主库一样。

使用CQRS有如下好处：

* R库的结构和数据表会针对业务进行合理的设计，提高性能；
* R库通常会去正规化，存储一些冗余数据来减少必要的join操作；
* R库可以随着业务重构优化，而不影响业务领域模型和主库；
* R库的查询不会给主库带来任何压力；
* 可以针对不同的查询请求建立不同的R库来分担压力。

### 如何实现？

事件驱动架构不仅可以用于分布式数据一致性的保证，还能借助物化视图和CQRS，通过事件来维护视图，从而实现分布式数据查询。

维护物化视图的服务订阅相关事件，并在事件发生时更新视图。





