---
layout: post
title: '红包拆分'
date: 2018-06-07
author: Feihang Han
tags: 算法
---

我们在扫货小分队产品中设计了一个回血红包，其中涉及红包随机拆分算法。

> 扫货小分队是基于手淘群聊产品去组建的一个分享靠谱宝贝、一起扫货的熟人交流群。这个产品的目标主要是受手淘沉淀和利用熟人朋友关系。用户可以在群里交流商品，分享好货，凑单购物，获回血红包和定向优惠。

# 模型

在红包模型中，假设`N`个人抢`m`元红包。由于红包最小数值为0.01元，红包可抢的数值是离散的。不妨认为0.01元是红包的最小粒子，则可以把`m`元等价成`M(=m*100)`份红包粒子。

那么模型可以简化为，`N`个人抢`M`份红包，`M & N`均为正整数。

# 随机拆分

随机拆分思路则是，在[0, M]中随机找(N-1)个不同的数值为x1,x2...xn。

那么第一份是x1，第二份是x2-x1，以此类推，最后一份是M-xn。

这是一种一次性拆好所有红包的思路。

# 保非算法

为了让更多抢红包的人有参与感，我们不希望红包拆分的太随机，导致非洲用户只能领取几分钱，而部分欧洲用户领取了大部分红包。

我们考虑以下这种保非（保护非洲人）算法：

- 剩余`N`个人抢`M`份红包的模型中，给下一个可抢红包的份额设置上限，上限为剩余平均红包分数的两倍。
在这种情况下，假设剩余10个人抢M份红包，那么下一个红包只能在`[1,2/10*M]`之间随机。通过这种限制，可以防止前面的某个欧洲人抢了太多红包，而导致后面一堆的非洲人。


- 当剩余人数<=2时，需要额外增加一个上限`M-N+1`，以此保证剩下的人最少还能领取1份。因为如果不这么做，会产生以下情况：
    - 当剩余人数`=2`时，下一个红包份数在`[0,2/2*M]`之间随机
    - 当剩余人数`=1`时，下一个红包份数在`[0,2/1*M]`之间随机

- 最终产生一个红包算法，即下一个红包份数为`randInt[1, MIN(2/N*M, M-N+1)]`。

这是一种单个拆红包的思路。
