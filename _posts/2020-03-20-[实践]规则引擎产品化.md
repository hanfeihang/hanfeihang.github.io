---
layout: post
title: '规则引擎产品化'
date: 2020-03-20
author: Feihang Han
tags: 实践
---

# 背景
新零售电商域下的消费链接场景下，衍生出了许多的产品形态，有面向商家的BC群，面向用户的CC群，客服咨询接待的BC单聊，以及淘友之间的CC单聊。随着业务增长，消息量也呈现几何指数级膨胀。这些消息在用户之间来回穿梭，如果没有很好的约束和规范这些消息发送行为，会给业务带来不稳定的因素。

在这样的背景下，不同的业务方产生了不同的规则。有的场景下需要校验淘气值，有的校验敏感词，不一而足。在早期业务高速增长期，通过建设一个中心化的规则中心，通过硬编码的手段来定义规则从而快速支撑业务，但是到了业务平稳期则需要考虑更为科学的消息治理方式。

简单总结下，早期的规则治理做法有以下弊端：
1. 规则不直观：需要看代码才能知道现在某个业务使用了哪些规则。
2. 可复用性差：虽然不同的业务形态不一样，但是有不少规则是类似的。
3. 流量中心化：任何业务方发送消息，流量都需要经过规则中心，来进行规则的判断。
4. 效果无法量化：新规则上线的时候，无法知道这个规则是否真的适合这个业务，无法提供有效的数据支撑业务决策。

# 规则治理
虽然有多种弊端，但是早期的规则中心也成功的快速支撑业务的高速增长，共同成长为一个庞然大物，而现在是时候来考虑如何科学的治理这些规则，告别那些野蛮生长的分支逻辑。

“治代码若烹小鲜。”用代码治理代码，往往是最高效的手段之一。那么如何打造一个产品化的规则中心，使之更好的治理规则呢？

首先，需要明确规则引擎的几个概念：
1. 何为规则，一个业务规则包含一组条件和在此条件下执行的操作。其理论基础是:设置一个或多个条件，当满足这些条件时会触发一个或多个操作。
2. 引入规则集的概念，可以将其理解成一组规则的集合，以此来表达某个场景下的一组有业务相关性的规则的集合。
3. 规则有一个条件逻辑表达式，以此表示条件之间的and、or、not的逻辑组合。比如【发送者淘气值>500 && 内容不存在敏感词】。
4. 通过Facts（事实）来维系引擎内外的执行上下文。

那么基于这些概念，可以构筑规则引擎的执行域骨架。

其次，还需要思考如何配置这些规则，于是引入以下几个概念：
1. 定义ConditionSchema和ActionSchema，提供对条件和动作的配置描述。
2. 条件和动作的底层逻辑都是函数调用，均可以抽象成Function。引入FunctionMethod来标记该函数。
3. 基于ParamConfigurable、ParamRequired、ParamContext描述不同性质的参数。
4. RangeSchema限定参数可选值的范围。

通过引入这些注解，我们可以构筑规则引擎的配置域。

最后，基于上述两个域，补充完善接口域、能力域和流程域，就完成了规则引擎的领域设计。

![](/assets/doc_imgs/规则引擎设计.jpg)

# 能力扩展
如果说上面的设计，只是覆盖了基本的规则引擎能力，那我们还要针对消息域作出一些特色化的能力扩展。
- 支持规则可视化和编排：可视化的规则管理配置后台，是产品化表达的第一步，也是解决规则不直观的最佳方案。
- 去中心化执行：由于IM的业务方比较分散，需要有一个统一的规则引擎配置入口，基于RPC调用识别到其他应用的可用条件与动作。同时为了避免中心化执行的单点风险，支持配置下发，去中心执行。
- 高效的重用能力：IM域有很多条件和动作是类似的，平台可以将这些条件/动作可以复用到多个规则和规则集合，避免重复工作。
- 效果可量化：执行新的规则以观察模式上线，不影响现有业务，同时观察数据是否符合预期。线上的日志支持回放，方便排查问题。

# 产品化
通过提供富客户端，接入业务应用，提供条件和动作的扫描机制，可以帮助业务快速接入规则引擎。
通过管理后台，可视化编排规则和规则集，并实时获取执行数据，以此来帮助业务更好的作出决策。
这一系列组合拳，便是消息域下的规则引擎产品化思路。虽然目前只走出了第一步，未来还有很多事情可以做。譬如基于表达树的表达式执行，结合指标数据，可以动态调整并达到最优的执行效率。
    




