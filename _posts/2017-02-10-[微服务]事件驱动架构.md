# \[微服务\]事件驱动架构

## 问题

每个服务一个数据库的模式下，每一个服务拥有自己的数据库。一些业务事务需要跨多个服务，因此需要一个机制来保证数据一致性。

例如，假设你正在打造一个电子商城应用。这个应用需要保证每一个新的订单不会超过客户的信用额度上限。因为订单服务和客户服务是不同的服务，数据库也是分开的，无法使用ACID事务来保证一致性。理论上，它可以使用分布式事务来跨多个服务，然而对于现代应用来说，分布式事务并不是一个最好的选择。

# 方案

使用事件驱动的，最终一致的方法。每个服务在更新数据后发布一个事件，其他服务订阅该事件。当其他服务接收到事件后，对数据做出相应的更新。

# 结果

优点：

* 它能保证一个应用维护各自的数据一致性，而不使用分布式事务。

缺点：

* 编程模型会变得复杂

也有以下问题要解决：

* 为了变得可靠，应用必须原子性的更新数据库和发布一个事件。传统的分布式事务机制不能同时作用于数据库和消息代理。因此需要采用下面提到的模式。

# 例子

一个电子商务应用可以使用以下方法：

1. 订单服务创建一个挂起状态的订单，并且发布一个订单创建事件。
2. 客户服务收到这个事件，尝试为此订单预留额度，然后发布一个额度预留事件/额度超限事件。
3. 订单服务收到客服服务发出的事件，然后更改订单状态，变成通过/取消。

# 相关模式

* 每个服务一个数据库模式
* 通过以下几种模式保证原子性的更新状态和发布事件：



1. Event sourcing
2. Application events
3. Database triggers
4. Transaction log tailing

# 参考

[http://microservices.io/patterns/cn/data/event-driven-architecture.html](http://microservices.io/patterns/cn/data/event-driven-architecture.html)

