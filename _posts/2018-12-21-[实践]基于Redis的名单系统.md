---
layout: post
title: '基于Redis的名单平台'
date: 2018-12-21
author: Feihang Han
tags: Redis 实践
---

目前集团已有的配置类中间件只能处理有限大小的配置信息，无法处理万级别以上的名单配置，而很多业务会有较大量级别的名单灰度需求。
集团还没有一个很好的切中该垂直领域的配置平台。鉴于此，我们打算做一个轻量级、专门面向万级别以上的名单配置平台，来切入该垂直领域。

与现有配置类中间件的对比如下：

| 维度\平台 | 名单平台 | Diamond/Switch |
| :------| ------: | :------: |
| 支持名单总数上限 | 理论上无限制 | 万级别以下 |
| 占用JVM内存 | 使用Redis存储，无需维护在内存，占用内存空间忽略不计 | 完整名单占用空间 |
| 操作难易度 | 可视化管理后台。方便增、删、查、获取名单总数操作。 | 操作不便。需要从Diamond/Switch复制出来再进行相关文本操作。 |

## 简介

名单平台致力于解决业务灰度期间的名单控制，降低产品迭代升级的影响范围。

#### 核心功能

名单平台主要是给业务方提供简单方便的名单系统，方便业务方自定义灰度期间的人群。功能如下：

- 统一接入
    - 自动化配置接入，开箱即用
    - 提供统一标准化接口，降低应用开发成本
    - 支持名单过期和版本控制

- 智能运维
    - 提供可视化管控后台，支持批量导入名单
    - 用户可根据名单总量预期自定义存储资源
    - 可视化数据查询，方便用户查询名单信息
    - 支持历史监控，方便查看名单命中率等指标
    
#### 适用场景

根据名单平台的特性，其使用场景如下：

- 万级以上大量名单存储查询
- 运营人员有名单干预管控需求
- 指定名单及规则约束


## 产品

名单系统由二方包(名单SDK)和名单后台组成，参与人员主要涉及业务方、运营小二和管理员，各个角色和该系统的交互如下：

- 业务方
    - 注册应用，申请Namespace，并接入名单SDK
    - 通过后台管控名单列表
    - 通过SDK查询名单信息
- 运营小二
    - 通过后台管控名单列表
    - 通过后台查询名单信息
- 管理员
    - 应用审批，应用名及 NameSpace 申请管控
    - 产品管理，包括日常运维、故障处理、补丁更新等支持

![](/assets/doc_imgs/wanted/名单系统-产品逻辑.png)

## 方案

#### 存储方案

基于Redis的Hash结构进行存储，考虑到名单容量的可扩展性，做了分库分片路由规则。

- 分库

考虑到后期单个Redis的性能瓶颈，在配置中引入多Redis的管理。
namespace在申请的时候就确定一个DB。

- 分片

由于名单的容量往往会是万级别，如果不做分片，会造成热点数据和数据倾斜。
Redis对于数据倾斜的官方描述如下：
> Godkey是Redis的特有情况，能够同时触发热点和数据倾斜的一种用法。洪水猛兽。

为了避免产生GodKey，我们需要针对pkey进行打散设计。
名单系统维护一份namespace的配置信息，里面含有当前版本号与分片数。
pkey:{namespace}\_{version}\_{segment}
每次存储名单之前，先将名单hash后，选择其中一个分片进行存储。查询的时候同理。


#### 配置同步

扩容或者其他配置变更的场景下，服务端需要将配置同步到各个SDK端。

![](/assets/doc_imgs/wanted/名单系统-配置流程.png)

#### 查询流程

- 为了降低重复的判断请求，在判断的入口处设计了LocalCache。
- 引入BloomFilter，针对大容量名单进行大数据去重，控制误判率在1%。
- 通过HashBucket算法，找到名单对应的存储分片。


![](/assets/doc_imgs/wanted/名单系统-查询流程.png)


#### 领域模型

一份namespace代表了一份名单，由DataSource和RuleChain组成。

- DataSource代表了名单数据来源；
- RuleChain则使用链式模式进行名单过滤。

![](/assets/doc_imgs/wanted/名单系统-数据设计.png)


#### 状态机
    
为了避免名单同时进行多项操作（扩容、编辑等），引入状态机来解决这个问题。
只有在合理的状态下，才能进行对应的操作。
编辑状态只能对名单进行编辑，拒绝扩容操作；扩容状态同理。
    


