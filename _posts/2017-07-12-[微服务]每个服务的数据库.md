---
layout: post
title: '微服务的数据库架构'
date: 2017-07-12
author: Feihang Han
tags: 微服务
---

# 背景

假设你正在使用微服架构模式开发在线商店中的应用。大多数服务需要在各种不同类型的数据库中保存数据。例如，订单服务存储订单信息，客户服务存储客户信息。

# 问题

在微服务应用中的数据库架构是什么？

# 需求

* 服务必须松散耦合，以便它们可以独立地开发、部署和伸缩
* 某些业务事务必须强制不变量跨越多个服务。例如，订单服务必须验证新订单不会超过客户的信用限额。其他业务交易，必须更新由多个服务拥有的数据。
* 一些业务事务需要查询由多个服务拥有的数据。例如，视图可用信用服务必须查询客户得到可用信用额度，查询订单来计算订单总金额。
* 某些查询必须组合由多个服务所拥有的数据。例如，在特定地区寻找客户和他们最近的订单需要客户和订单之间的数据组合。
* 数据库有时必须为了扩大大规模进行复制和分片。查看[Scale Cube](http://microservices.io/articles/scalecube.html)。
* 不同的服务有不同的数据存储要求。对一些服务而言，关系型数据库是最好的选择，其他服务可能需要一个NoSQL数据库，比如MongoDB或者Neo4J，前者能更好的存储复杂的，非结构化的数据，后者能更有效的存储和查询图型数据结构。

# 方案

每个服务选用适合自己的数据库，并且只通过api暴露数据访问。以下示意图展现了这种模式的结构：

![](/assets/doc_imgs/databaseperservice.png)

服务的数据库是服务实现的较为重要的一个部分，它不能被其他服务直接访问。

服务私有化保存数据的方式有一些不同的方式。你不需要给每一个服务单独提供一个数据库。假设你正在使用一个关系型数据库，那么有以下几种选项：

* 每个服务一些私有表 - 每一个服务拥有一组表，并且这些表只能被该服务访问

* 每个服务一个schema - 每个服务有一个数据库schema，并且这个数据库schema只能被该服务访问
* 每个服务一个数据库服务器 - 每个服务有用一个独立的数据库服务器

前两种模式具有最低的开销。使用每个服务一个schema的模式是有吸引力的，因为它使所有权更清晰。一些高吞吐量服务可能需要自己的数据库服务器。

建立分界确保模块化是一个好主意。例如，你可以给每个服务配置不同的数据库用户，使用数据库访问控制机制比如grants。如果不建立分界封装服务，开发者常常会试图去绕过服务的API直接访问某个服务的数据。

# 结果

使用每个服务一个数据库模式有以下的优点：

* 确保服务是松耦合的。对于一个服务的数据库变动不会影响其他服务。

* 每个服务可以使用最适合它需求的数据库类型。例如，一个需要文本搜索的服务可以使用ElasticSearch，一个操作社交图型关系的服务可以使用Neo4j

使用每个服务一个数据库模式有以下的缺点：

* 实现跨多个服务的业务事务是不简单的。由于存在CAP理论，最好避免使用分布式事务。此外，很多现代数据库\(NoSQL\)不支持分布式事务。最好的解决方案是使用最终一致性，事件驱动架构。服务在更新数据时发布事件，其他服务订阅事件，并更新自己的数据。

* 实现跨服务查询并组合数据是有挑战的，有以下几个解决方案：

* 应用端组合 - 应用对数据进行组合而不是数据库。例如一个服务（或者API网管）可以通过客户服务检索客户信息，然后通过订单服务查询该客户最近的订单信息。

* 命令查询职责分离 - 维护一个或者多个包含多个服务的数据的物化视图。某些服务通过订阅其他服务发布的事件来更新自己的数据，并维护一份视图。例如，在线购物商城可以通过组合客户和订单信息来维护一个视图，方便提供查询某些特定地域的客户以及他们最近的订单。某个订阅了客户、订单事件的服务更新维护这份视图。

* 管理多个SQL和NoSQL数据库相当复杂。

# 参考

[http://microservices.io/patterns/cn/data/database-per-service.html](http://microservices.io/patterns/cn/data/database-per-service.html)

