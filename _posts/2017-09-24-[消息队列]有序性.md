---
layout: post
title: '消息队列的有序性'
date: 2017-09-24
author: Feihang Han
tags: 消息队列
---

分布式消息系统作为实现分布式系统可扩展、可伸缩性的关键组件，需要具有高吞吐量、高可用等特点。而谈到消息系统的设计，需要关注以下几点：

* 消息的顺序性
* 消息的重复性
* 消息的事务性

# 有序性

消息有序指的是可以按照消息的发送顺序来消费。例如：一笔订单产生了 3 条消息，分别是订单创建、订单付款、订单完成。消费时，要按照顺序依次消费才有意义。与此同时多笔订单之间又是可以并行消费的。

首先来看如下示例，假如生产者产生了2条消息：M1、M2，要保证这两条消息的顺序，应该怎样做？可能如下模型1

![](http://dbaplus.cn/uploadfile/2017/0321/20170321102002123.jpg)

假定M1发送到S1，M2发送到S2，如果要保证M1先于M2被消费，那么需要M1到达消费端被消费后，通知S2，然后S2再将M2发送到消费端。这个模型存在的问题是，如果M1和M2分别发送到两台Server上，就不能保证M1先达到MQ集群，也不能保证M1被先消费。

**一种简单的方式就是将M1、M2发送到同一个Server上：**

![](http://dbaplus.cn/uploadfile/2017/0321/20170321102015363.jpg)

这样可以保证M1先于M2到达MQServer（生产者等待M1发送成功后再发送M2），根据先达到先被消费的原则，M1会先于M2被消费，这样就保证了消息的顺序。

这个模型也仅仅是理论上可以保证消息的顺序，在实际场景中，由于存在网络延迟，可能会遇到下面的问题：

![](http://dbaplus.cn/uploadfile/2017/0321/20170321102024554.jpg)

只要将消息从一台服务器发往另一台服务器，就会存在网络延迟问题。如上图所示，如果发送M1耗时大于发送M2的耗时，那么M2就仍将被先消费，仍然不能保证消息的顺序。即使M1和M2同时到达消费端，由于不清楚消费端1和消费端2的负载情况，仍然有可能出现M2先于M1被消费的情况。

那如何解决这个问题？将M1和M2发往同一个消费者，且发送M1后，需要消费端响应成功后才能发送M2。

这样的模型就严格保证消息的顺序，细心的你仍然会发现问题，消费端1没有响应Server时有两种情况，一种是M1确实没有到达\(数据在网络传送中丢失\)，另外一种消费端已经消费M1且已经发送响应消息，只是MQ Server端没有收到。如果是第二种情况，重发M1，就会造成M1被重复消费。也就引入了我们要说的第二个问题，消息重复问题，这个后文会详细讲解。

回过头来看消息顺序问题，严格的顺序消息非常容易理解，也可以通过文中所描述的方式来简单处理。总结起来，要实现严格的顺序消息，简单且可行的办法就是：**保证生产者 - MQServer - 消费者是一对一对一的关系。**这样的设计虽然简单易行，但也会存在一些很严重的问题，比如：

* 并行度就会成为消息系统的瓶颈（吞吐量不够）
* 更多的异常处理，比如：只要消费端出现问题，就会导致整个处理流程阻塞，我们不得不花费更多的精力来解决阻塞的问题。

但我们的最终目标是要集群的高容错性和高吞吐量。这似乎是一对不可调和的矛盾，那么该如何解决的？

**世界上解决一个计算机问题最简单的方法：“恰好”不需要解决它！——沈询**

有些问题，看起来很重要，但实际上我们可以通过合理的设计或者将问题分解来规避。如果硬要把时间花在解决问题本身，实际上不仅效率低下，而且也是一种浪费。从这个角度来看消息的顺序问题，我们可以得出两个结论：

* 不关注乱序的应用实际大量存在
* 队列无序并不意味着消息无序

所以从业务层面来保证消息的顺序而不仅仅是依赖于消息系统，是不是我们应该寻求的一种更合理的方式？

* 正向状态机是一个选择
* 局部有序，即同一个分区内的消息有序



